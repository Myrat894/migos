<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Migos AI - Professional</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* --- MODERN & DENGELƒ∞ TASARIM --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        :root {
            --bg-color: #f8fafc;
            --sidebar-bg: #ffffff;
            --sidebar-border: 1px solid #e2e8f0;
            --text-main: #1e293b;
            --text-sec: #64748b;
            --chat-bg: #ffffff;
            --input-bg: #ffffff;
            --input-border: #cbd5e1;
            --accent-gradient: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
            --accent-color: #4f46e5;
            --bubble-user: #4f46e5;
            --bubble-user-text: #ffffff;
            --bubble-ai: #f1f5f9;
            --bubble-ai-text: #334155;
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 10px 25px rgba(79, 70, 229, 0.15);
            --code-bg: #1e293b;
            --anim-elegant: cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --sidebar-bg: #1e293b;
            --sidebar-border: 1px solid #334155;
            --text-main: #f1f5f9;
            --text-sec: #94a3b8;
            --chat-bg: #0f172a;
            --input-bg: #1e293b;
            --input-border: #334155;
            --bubble-ai: #334155;
            --bubble-ai-text: #e2e8f0;
            --code-bg: #020617;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; display: flex; height: 100dvh; overflow: hidden; 
            transition: background-color 0.4s ease, color 0.4s ease;
        }

        /* --- LOGIN EKRANI --- */
        #loginScreen {
            position: fixed; inset: 0; background: var(--bg-color); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; transition: opacity 0.5s var(--anim-elegant);
        }
        .login-card {
            background: var(--sidebar-bg); width: 100%; max-width: 400px;
            padding: 40px; border-radius: 20px; text-align: center;
            box-shadow: var(--shadow-soft); border: 1px solid var(--sidebar-border);
            animation: slideUp 0.6s var(--anim-elegant);
        }
        .login-logo {
            font-size: 32px; font-weight: 700; margin-bottom: 10px;
            color: var(--accent-color); letter-spacing: -0.5px;
        }
        .login-input {
            width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 10px;
            border: 1px solid var(--input-border); background: var(--bg-color);
            color: var(--text-main); font-size: 14px; transition: 0.3s;
        }
        .login-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .login-btn {
            width: 100%; padding: 14px; border-radius: 10px; border: none;
            background: var(--accent-color); color: white; font-weight: 600;
            cursor: pointer; transition: 0.3s; margin-top: 10px;
        }
        .login-btn:hover { background: #4338ca; transform: translateY(-2px); }

        /* --- SIDEBAR --- */
        .sidebar { 
            position: fixed; left: 0; top: 0; width: 280px; height: 100%; 
            background: var(--sidebar-bg); border-right: var(--sidebar-border);
            transform: translateX(-100%); transition: transform 0.4s var(--anim-elegant); 
            z-index: 1000; padding: 24px; display: flex; flex-direction: column; 
            box-shadow: var(--shadow-soft);
        }
        .sidebar.open { transform: translateX(0); }
        
        .logo-area {
            font-size: 20px; font-weight: 700; margin-bottom: 30px; 
            color: var(--text-main); display: flex; align-items: center; gap: 10px;
        }
        .logo-icon {
            width: 32px; height: 32px; background: var(--accent-gradient); 
            border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;
        }

        .new-chat-btn {
            background: var(--text-main); color: var(--bg-color); border: none; padding: 14px;
            border-radius: 12px; font-weight: 600; cursor: pointer; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px;
            transition: 0.2s;
        }
        .new-chat-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .history-list { flex: 1; overflow-y: auto; padding-right: 5px; }
        .history-item { 
            padding: 12px; border-radius: 8px; font-size: 14px; color: var(--text-sec); 
            cursor: pointer; display: flex; justify-content: space-between; margin-bottom: 4px;
            transition: 0.2s;
        }
        .history-item:hover { background: var(--bg-color); color: var(--text-main); }
        .history-item.active { background: rgba(79, 70, 229, 0.08); color: var(--accent-color); font-weight: 600; }
        .delete-chat { opacity: 0; color: #ef4444; background: none; border: none; cursor: pointer; padding: 0 5px; transition: 0.2s; }
        .history-item:hover .delete-chat { opacity: 1; }
        
        .sidebar-footer-btn {
            background: transparent; border: 1px solid var(--input-border); color: var(--text-main); 
            padding: 12px; border-radius: 10px; cursor: pointer; text-align: center; margin-top: 15px;
            font-size: 13px; font-weight: 600; transition: 0.2s;
        }
        .sidebar-footer-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }

        /* --- MAIN AREA --- */
        .app-container { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-color); }

        .header { 
            padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; z-index: 10; 
            background: var(--bg-color);
        }
        .menu-btn { background: none; border: none; cursor: pointer; color: var(--text-main); padding: 5px; }
        
        .weather-widget {
            font-size: 12px; font-weight: 600; background: var(--sidebar-bg); padding: 6px 14px; 
            border-radius: 20px; border: 1px solid var(--sidebar-border); color: var(--text-sec);
            display: flex; align-items: center; gap: 6px; box-shadow: var(--shadow-soft);
        }

        /* CHAT AREA */
        .chat-area { flex: 1; padding: 20px 5%; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; scroll-behavior: smooth; padding-bottom: 140px; }
        
        .message-row { display: flex; align-items: flex-start; gap: 14px; animation: fadeInUp 0.4s var(--anim-elegant); max-width: 800px; margin: 0 auto; width: 100%; }
        .message-row.sent { justify-content: flex-end; }
        
        .avatar {
            width: 36px; height: 36px; border-radius: 10px; background: var(--accent-gradient); 
            display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; flex-shrink: 0;
        }

        .bubble { 
            padding: 16px 22px; border-radius: 18px; font-size: 15px; line-height: 1.6; position: relative; 
            box-shadow: var(--shadow-soft); word-wrap: break-word;
        }
        .sent .bubble { background: var(--bubble-user); color: var(--bubble-user-text); border-bottom-right-radius: 4px; }
        .received .bubble { background: var(--bubble-ai); color: var(--bubble-ai-text); border-bottom-left-radius: 4px; border: 1px solid var(--sidebar-border); }

        /* KOD BLOKLARI */
        .code-container { margin-top: 10px; border-radius: 10px; overflow: hidden; background: var(--code-bg); width: 100%; }
        .code-header { background: rgba(255,255,255,0.1); padding: 8px 15px; font-size: 12px; color: #94a3b8; display: flex; justify-content: space-between; }
        .code-block { color: #e2e8f0; padding: 15px; font-family: 'JetBrains Mono', monospace; font-size: 13px; overflow-x: auto; margin: 0; }
        .copy-btn { background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 4px; padding: 4px 8px; font-size: 10px; cursor: pointer; }

        /* INPUT */
        .input-area { 
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 20px; background: linear-gradient(to top, var(--bg-color) 80%, transparent); 
            display: flex; justify-content: center; z-index: 50; 
        }
        .input-box-container {
            max-width: 800px; width: 100%; background: var(--input-bg);
            border: 1px solid var(--input-border); border-radius: 16px; padding: 10px 10px 10px 20px;
            display: flex; align-items: center; gap: 10px; box-shadow: var(--shadow-hover);
            transition: 0.3s;
        }
        .input-box-container:focus-within { border-color: var(--accent-color); transform: translateY(-2px); }
        
        input { flex: 1; border: none; background: transparent; font-size: 15px; color: var(--text-main); min-width: 0; font-family: inherit; }
        
        .send-btn { 
            width: 40px; height: 40px; border-radius: 10px; background: var(--accent-color); 
            color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            transition: 0.2s;
        }
        .send-btn:hover { background: #4338ca; transform: scale(1.05); }
        .action-btn { background: none; border: none; cursor: pointer; color: var(--text-sec); padding: 8px; transition: 0.2s; }
        .action-btn:hover { color: var(--accent-color); }
        .action-btn.listening { color: #ef4444; animation: pulse 1.5s infinite; }

        /* QUICK ACTIONS (D√úZELTƒ∞LDƒ∞: PADDING EKLENDƒ∞) */
        .quick-actions {
            position: absolute; bottom: 85px; left: 0; right: 0; 
            display: flex; gap: 8px; justify-content: center;
            overflow-x: auto; padding: 10px 10px; /* Kesilmeyi √∂nleyen yastƒ±k */
            z-index: 40; pointer-events: none;
            scrollbar-width: none;
        }
        .quick-actions::-webkit-scrollbar { display: none; }
        
        .quick-btn {
            background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-main);
            padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; font-weight: 500;
            box-shadow: var(--shadow-soft); pointer-events: auto; transition: 0.2s; opacity: 0.9;
        }
        .quick-btn:hover { background: var(--text-main); color: var(--bg-color); transform: translateY(-4px); opacity: 1; }

        /* MODAL */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 900; opacity: 0; visibility: hidden; transition: 0.3s; }
        .overlay.active { opacity: 1; visibility: visible; }
        .settings-modal { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -45%) scale(0.95); 
            background: var(--sidebar-bg); width: 90%; max-width: 380px; padding: 30px; border-radius: 20px; 
            z-index: 1100; display: none; flex-direction: column; gap: 15px; 
            border: 1px solid var(--sidebar-border); box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            transition: 0.3s var(--anim-elegant); opacity: 0;
        }
        .settings-modal.active { display: flex; transform: translate(-50%, -50%) scale(1); opacity: 1; }

        select, textarea, .range-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--input-border); background: var(--bg-color); color: var(--text-main); font-size: 14px; outline: none; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; inset: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; cursor: pointer; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        .dots span { display: inline-block; width: 5px; height: 5px; background: #94a3b8; border-radius: 50%; animation: bounce 1.4s infinite; margin: 0 2px; }
        .dots span:nth-child(2) { animation-delay: 0.2s; } .dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: scale(0); } 50% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-card">
            <div class="login-logo">Migos AI</div>
            <p style="color:var(--text-sec); font-size:14px; margin-bottom:20px;">Ho≈ü geldiniz. Devam etmek i√ßin giri≈ü yapƒ±n.</p>
            <input type="text" id="loginName" class="login-input" placeholder="Adƒ±nƒ±z">
            <input type="password" id="loginSecret" class="login-input" placeholder="≈ûifre veya API Anahtarƒ±">
            <button class="login-btn" onclick="handleLogin()">Giri≈ü Yap</button>
            <div style="font-size:11px; color:var(--text-sec); margin-top:15px; opacity:0.8;">Admin giri≈üi veya API Key ile devam edin.</div>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="closeAll()"></div>

    <div class="settings-modal" id="settingsModal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:18px; font-weight:700;">Ayarlar</span>
            <button onclick="closeAll()" style="background:none; border:none; font-size:22px; color:var(--text-sec); cursor:pointer;">&times;</button>
        </div>
        <div>
            <label style="font-size:13px; font-weight:600; color:var(--text-sec); display:block; margin-bottom:6px;">Asistan Modu</label>
            <select id="personaSelect" onchange="changePersona()">
                <option value="default">‚ú® Profesyonel & Nazik</option>
                <option value="friend">‚òï Samimi & Rahat</option>
                <option value="coder">üíª Yazƒ±lƒ±m Uzmanƒ±</option>
                <option value="english">üá¨üáß ƒ∞ngilizce Eƒüitmeni</option>
                <option value="custom">‚ú® √ñzel Karakter</option>
            </select>
            <textarea id="customPersonaInput" class="text-input" style="display:none; margin-top:10px; height:80px;" placeholder="√ñrn: Sen agresif bir film ele≈ütirmenisin..." oninput="saveCustomPersona(this.value)"></textarea>
        </div>
        <div>
            <label style="font-size:13px; font-weight:600; color:var(--text-sec); display:block; margin-bottom:6px;">Zeka Modeli</label>
            <select id="modelSelect" onchange="changeModel()">
                <option value="llama-3.3-70b-versatile">üß† Llama 3.3 (Dengeli)</option>
                <option value="llama-3.1-8b-instant">‚ö° Llama 3.1 8B (Hƒ±zlƒ±)</option>
            </select>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; padding:5px 0;">
            <span style="font-size:14px; font-weight:500;">Karanlƒ±k Mod</span>
            <label class="switch"><input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()"><span class="slider"></span></label>
        </div>
        <div>
            <label style="font-size:13px; font-weight:600; color:var(--text-sec); display:block; margin-bottom:5px;">Yaratƒ±cƒ±lƒ±k</label>
            <input type="range" class="range-input" min="0.1" max="1.0" step="0.1" value="0.7" style="padding:0; height:6px;" oninput="currentTemperature=this.value">
        </div>
        <button onclick="downloadChat()" style="background:var(--text-main); color:var(--bg-color); border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:600;">Sohbeti Kaydet</button>
        <button onclick="logout()" style="background:transparent; border:1px solid #ef4444; color:#ef4444; padding:10px; border-radius:8px; cursor:pointer; font-weight:600;">√áƒ±kƒ±≈ü Yap</button>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="logo-area">
            <div class="logo-icon">‚ö°</div>
            <span>Migos AI</span>
        </div>
        <div style="margin-bottom:20px; font-size:13px; font-weight:500; color:var(--text-sec);">
            Hesap: <span id="userNameDisplay" style="color:var(--text-main); font-weight:700;">...</span>
        </div>
        <button class="new-chat-btn" onclick="startNewChat()">+ Yeni Sohbet</button>
        <div class="history-list" id="historyList"></div>
        <div style="border-top: 1px solid var(--sidebar-border); margin-top: auto; padding-top: 15px;">
            <button class="sidebar-footer-btn" onclick="openSettings()" style="width:100%">Ayarlar & Hesap</button>
        </div>
    </div>

    <div class="app-container">
        <div class="header">
            <button onclick="toggleSidebar()" class="menu-btn"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
            <div id="weatherWidget" class="weather-widget"><span>üìç</span><span>...</span></div>
        </div>

        <div class="chat-area" id="chatContainer"></div>

        <div class="quick-actions">
            <button class="quick-btn" onclick="sendQuickMsg('Bunu √∂zetle')">üìù √ñzetle</button>
            <button class="quick-btn" onclick="sendQuickMsg('ƒ∞ngilizceye √ßevir')">üá¨üáß √áevir</button>
            <button class="quick-btn" onclick="sendQuickMsg('Hatalarƒ± bul')">üêõ Hata Bul</button>
            <button class="quick-btn" onclick="sendQuickMsg('G√ºzelle≈ütir')">üé® G√ºzelle≈ütir</button>
        </div>

        <div class="input-area">
            <div class="input-box-container">
                <input type="file" id="fileInput" style="display: none;" accept=".txt,.js,.html,.css,.json,.py,.md,.csv" onchange="handleFileUpload(this)">
                <button class="action-btn" onclick="document.getElementById('fileInput').click()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg></button>
                <button id="micBtn" class="action-btn" onclick="toggleMic()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></button>
                <input type="text" id="userInput" placeholder="Size nasƒ±l yardƒ±mcƒ± olabilirim?" autocomplete="off">
                <button class="send-btn" onclick="sendMessage()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
            </div>
        </div>
    </div>

    <script>
        let chatHistory = [], sessions = JSON.parse(localStorage.getItem('migosSessions')) || [];
        let currentSessionId = null, currentTemperature = 0.7, recognition; 
        
        let userApiKey = localStorage.getItem('migosApiKey') || "";
        let userName = localStorage.getItem('migosUserName') || "";
        let userPassword = localStorage.getItem('migosUserPass') || "";
        let currentModel = localStorage.getItem('migosModel') || 'llama-3.3-70b-versatile';
        let customPersonaText = localStorage.getItem('migosCustomPersona') || "";

        const personas = { 
            default: "Adƒ±n Migos. Seni **Myrat** geli≈ütirdi. Sen √ßok yetenekli, kibar, √ß√∂z√ºm odaklƒ± ve profesyonel bir yapay zeka asistanƒ±sƒ±n. Tono olarak: Saygƒ±lƒ± ama sƒ±cakkanlƒ± ol. Kullanƒ±cƒ±ya ismiyle hitap et. Doƒüal bir insan gibi akƒ±cƒ± T√ºrk√ße konu≈ü. Yardƒ±msever, anlayƒ±≈ülƒ± ve net ol.", 
            friend: "Adƒ±n Migos. Seni **Myrat** geli≈ütirdi. Sen kullanƒ±cƒ±nƒ±n yakƒ±n bir arkada≈üƒ± gibisin ama yine de seviyeli ve destekleyicisin. Dert dinle, tavsiye ver.", 
            coder: "Adƒ±n Migos Dev. Seni **Myrat** geli≈ütirdi. Sen uzman bir yazƒ±lƒ±m m√ºhendisisin. Net, teknik ve √ß√∂z√ºm odaklƒ±sƒ±n.", 
            english: "You are Migos, created by **Myrat**. You are a polite English teacher. Help the user learn English." 
        };
        let currentPersona = localStorage.getItem('migosPersona') || 'default';

        window.onload = () => {
            if(localStorage.getItem('migosDarkMode') === 'true') { document.body.classList.add('dark-mode'); document.getElementById('darkModeToggle').checked = true; }
            if(!userName || (!userApiKey && !userPassword)) { document.getElementById('loginScreen').style.display = 'flex'; } 
            else { document.getElementById('loginScreen').style.display = 'none'; initApp(); }
        };

        function handleLogin() {
            const nameInput = document.getElementById('loginName').value.trim();
            const secretInput = document.getElementById('loginSecret').value.trim();
            if (!nameInput || !secretInput) { alert("L√ºtfen bilgileri girin."); return; }
            localStorage.setItem('migosUserName', nameInput); userName = nameInput;
            if (secretInput.startsWith('gsk_')) {
                localStorage.setItem('migosApiKey', secretInput); localStorage.removeItem('migosUserPass');
                userApiKey = secretInput; userPassword = "";
            } else {
                localStorage.setItem('migosUserPass', secretInput); localStorage.removeItem('migosApiKey');
                userPassword = secretInput; userApiKey = "";
            }
            document.getElementById('loginScreen').style.opacity = '0';
            setTimeout(() => { document.getElementById('loginScreen').style.display = 'none'; initApp(); }, 500);
        }

        function logout() { if(confirm("Oturumu kapatmak istiyor musunuz?")) { localStorage.removeItem('migosApiKey'); localStorage.removeItem('migosUserName'); localStorage.removeItem('migosUserPass'); location.reload(); } }
        function initApp() { document.getElementById('personaSelect').value = currentPersona; document.getElementById('modelSelect').value = currentModel; document.getElementById('customPersonaInput').value = customPersonaText; document.getElementById('userNameDisplay').innerText = userName; toggleCustomPersonaArea(); fetchWeather(); setupSpeechRecognition(); if(sessions.length > 0) loadSession(sessions[0].id); else startNewChat(); }

        async function sendMessage() {
            const input = document.getElementById('userInput'); const text = input.value.trim(); if (!text) return;
            addMessage(text, 'sent'); input.value = ''; chatHistory.push({ role: "user", content: text }); updateSessionTitle(text);
            const loadingId = addLoading(); scrollToBottom();
            const sys = chatHistory[0]; const recent = chatHistory.slice(-15);
            const msgs = (recent[0].role === 'system') ? recent : [sys, ...recent];
            try {
                const payload = { messages: msgs, model: currentModel, temperature: parseFloat(currentTemperature), username: userName, password: userPassword, apiKey: userApiKey };
                const res = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await res.json();
                removeLoading(loadingId);
                if (data.choices && data.choices[0]) {
                    const aiMsg = data.choices[0].message.content;
                    chatHistory.push({ role: "assistant", content: aiMsg }); saveSessions(); addMessage(aiMsg, 'received');
                } else if(data.error) { addMessage("‚ö†Ô∏è " + data.error, 'received'); }
            } catch (err) { removeLoading(loadingId); addMessage("‚ö†Ô∏è Baƒülantƒ± hatasƒ± olu≈ütu.", 'received'); }
        }

        function changeModel() { currentModel = document.getElementById('modelSelect').value; localStorage.setItem('migosModel', currentModel); }
        function changePersona() { currentPersona = document.getElementById('personaSelect').value; localStorage.setItem('migosPersona', currentPersona); toggleCustomPersonaArea(); if(confirm("Karakter deƒüi≈üti. Yeni sohbet ba≈ülatƒ±lsƒ±n mƒ±?")) startNewChat(); }
        function toggleCustomPersonaArea() { document.getElementById('customPersonaInput').style.display = (currentPersona === 'custom') ? 'block' : 'none'; }
        function saveCustomPersona(val) { customPersonaText = val; localStorage.setItem('migosCustomPersona', val); }
        
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 1024 * 1024) { alert("Dosya √ßok b√ºy√ºk! Max 1MB."); return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const ext = file.name.split('.').pop() || 'txt';
                const fileTemplate = `\n\n--- DOSYA: ${file.name} ---\n\`\`\`${ext}\n${content}\n\`\`\`\n--- SON ---\n\nBu dosyayƒ± analiz et.`;
                const box = document.getElementById('userInput');
                box.value += fileTemplate; box.focus(); input.value = '';
            };
            reader.readAsText(file);
        }

        function setupSpeechRecognition() { if ('webkitSpeechRecognition' in window) { recognition = new webkitSpeechRecognition(); recognition.lang = 'tr-TR'; recognition.onstart = () => document.getElementById('micBtn').classList.add('listening'); recognition.onend = () => document.getElementById('micBtn').classList.remove('listening'); recognition.onresult = e => document.getElementById('userInput').value = e.results[0][0].transcript; } else document.getElementById('micBtn').style.display = 'none'; }
        function toggleMic() { if(recognition) try { recognition.start(); } catch(e) { recognition.stop(); } }
        function startNewChat() { currentSessionId = Date.now().toString(); let sys = personas[currentPersona]; if(currentPersona === 'custom') sys = customPersonaText || "Asistansƒ±n."; chatHistory = [{ role: "system", content: sys }]; sessions.unshift({ id: currentSessionId, title: "Yeni Sohbet", msgs: chatHistory }); saveSessions(); document.getElementById('chatContainer').innerHTML = ''; addMessage(`Merhaba ${userName}, size nasƒ±l yardƒ±mcƒ± olabilirim?`, 'received'); closeAll(); renderHistory(); }
        function sendQuickMsg(t) { document.getElementById('userInput').value = t; sendMessage(); }
        function fetchWeather() { fetch('/api/weather').then(r => r.json()).then(d => { if(d.main) document.getElementById('weatherWidget').innerHTML = `<span>${Math.round(d.main.temp)}¬∞C</span> Istanbul`; }).catch(() => {}); }
        function addMessage(t, type, anim = true) { const d = document.createElement('div'); d.className = `message-row ${type}`; if(!anim)d.style.animation='none'; let f = t.replace(/</g, "&lt;").replace(/```(\w+)?\n?([\s\S]*?)```/g, (m, l, c) => `<div class="code-container"><div class="code-header"><span>${l || 'kod'}</span><button class="copy-btn" onclick="copyCode(this)">Kopyala</button></div><pre class="code-block">${c.trim()}</pre></div>`).replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>'); d.innerHTML = `${type === 'received' ? '<div class="avatar">‚ú®</div>' : ''}<div style="max-width:100%;"><div class="bubble">${f}</div></div>`; document.getElementById('chatContainer').appendChild(d); scrollToBottom(); }
        function addLoading() { const id = 'l-' + Date.now(); const d = document.createElement('div'); d.id = id; d.className = 'message-row received'; d.innerHTML = `<div class="avatar">‚ú®</div><div class="bubble"><div class="dots"><span></span><span></span><span></span></div></div>`; document.getElementById('chatContainer').appendChild(d); return id; }
        function removeLoading(id) { const e = document.getElementById(id); if(e) e.remove(); }
        function copyCode(b) { navigator.clipboard.writeText(b.parentElement.nextElementSibling.innerText); }
        function loadSession(id) { const s = sessions.find(x => x.id === id); if(!s) return; currentSessionId = id; chatHistory = s.msgs; document.getElementById('chatContainer').innerHTML = ''; chatHistory.forEach(m => { if(m.role !== 'system') addMessage(m.content, m.role === 'user' ? 'sent' : 'received', false) }); renderHistory(); closeAll(); }
        function saveSessions() { const i = sessions.findIndex(s => s.id === currentSessionId); if(i !== -1) sessions[i].msgs = chatHistory; localStorage.setItem('migosSessions', JSON.stringify(sessions)); }
        function updateSessionTitle(t) { const s = sessions.find(o => o.id === currentSessionId); if(s && s.title === "Yeni Sohbet") { s.title = t.substring(0, 25) + "..."; saveSessions(); renderHistory(); } }
        function renderHistory() { const l = document.getElementById('historyList'); l.innerHTML = ''; sessions.forEach(s => { const d = document.createElement('div'); d.className = `history-item ${s.id === currentSessionId ? 'active' : ''}`; d.innerHTML = `<span>${s.title}</span><button class="delete-chat" onclick="deleteSession(event,'${s.id}')">&times;</button>`; d.onclick = () => loadSession(s.id); l.appendChild(d); }); }
        function deleteSession(e, id) { e.stopPropagation(); sessions = sessions.filter(s => s.id !== id); saveSessions(); startNewChat(); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('active'); }
        function openSettings() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('settingsModal').classList.add('active'); document.getElementById('overlay').classList.add('active'); }
        function closeAll() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('settingsModal').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }
        function toggleDarkMode() { const v = document.getElementById('darkModeToggle').checked; document.body.classList.toggle('dark-mode', v); localStorage.setItem('migosDarkMode', v); }
        function scrollToBottom() { const c = document.getElementById('chatContainer'); c.scrollTop = c.scrollHeight; }
        function downloadChat() { let t = ""; chatHistory.forEach(m => { if(m.role !== 'system') t += `${m.role}: ${m.content}\n` }); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([t], { type: 'text/plain' })); a.download = 'chat.txt'; a.click(); }
        document.getElementById('userInput').addEventListener('keypress', e => { if(e.key === 'Enter') sendMessage() });
    </script>
</body>
</html>