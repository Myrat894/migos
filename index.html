<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Migos AI - Masterpiece</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* --- VISUAL MASTERPIECE VARIABLES --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        :root {
            /* Renk Paleti: Modern Indigo & Violet */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --text-main: #1e293b;
            --text-muted: #64748b;
            
            /* Glassmorphism (Cam Efekti) Deƒüi≈ükenleri */
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: 1px solid rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            
            --chat-bg: transparent;
            --input-bg: rgba(255, 255, 255, 0.9);
            
            /* Animasyonlar */
            --ease-elastic: cubic-bezier(0.68, -0.6, 0.32, 1.6); /* Yaylanma */
            --ease-smooth: cubic-bezier(0.16, 1, 0.3, 1);     /* Apple tarzƒ± akƒ±≈ü */
        }

        body.dark-mode {
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --input-bg: rgba(30, 41, 59, 0.9);
        }

        /* CANLI ARKAPLAN ANIMASYONU */
        body { 
            font-family: 'Outfit', sans-serif; 
            margin: 0; display: flex; height: 100dvh; overflow: hidden; 
            /* Hareketli Gradyan */
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-main);
        }
        
        body.dark-mode {
            background: linear-gradient(-45deg, #0f172a, #1e293b, #312e81, #1e1b4b);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- LOGIN EKRANI (GLASS) --- */
        #loginScreen {
            position: fixed; inset: 0; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(15px); /* Arkaplanƒ± bulanƒ±kla≈ütƒ±r */
            transition: opacity 0.6s var(--ease-smooth);
        }
        .login-card {
            background: var(--glass-bg); backdrop-filter: blur(20px);
            width: 100%; max-width: 400px; padding: 40px; border-radius: 30px; 
            text-align: center; border: var(--glass-border); box-shadow: var(--glass-shadow);
            transform: scale(0.9); animation: popIn 0.6s var(--ease-elastic) forwards;
        }
        .login-logo {
            font-size: 42px; font-weight: 800; margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }
        .login-input {
            width: 100%; padding: 16px; margin-bottom: 15px; border-radius: 16px;
            border: 2px solid transparent; background: rgba(255,255,255,0.5);
            color: var(--text-main); font-size: 15px; outline: none; transition: 0.3s;
            font-weight: 500;
        }
        .login-input:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2); }
        .login-btn {
            width: 100%; padding: 16px; border-radius: 16px; border: none;
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; font-weight: 700; font-size: 16px; cursor: pointer; 
            transition: 0.3s; margin-top: 10px;
        }
        .login-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(99, 102, 241, 0.4); }
        .login-btn:active { transform: scale(0.95); }

        /* --- SIDEBAR (GLASS) --- */
        .sidebar { 
            position: fixed; left: 0; top: 0; width: 280px; height: 100%; 
            background: var(--glass-bg); backdrop-filter: blur(25px);
            border-right: var(--glass-border);
            transform: translateX(-120%); transition: transform 0.6s var(--ease-smooth); 
            z-index: 1000; padding: 30px 20px; display: flex; flex-direction: column; 
            box-shadow: 20px 0 50px rgba(0,0,0,0.1);
        }
        .sidebar.open { transform: translateX(0); }
        
        .logo-area {
            font-size: 24px; font-weight: 800; margin-bottom: 35px; 
            color: var(--text-main); display: flex; align-items: center; gap: 12px;
        }
        .logo-icon {
            width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white;
            font-size: 20px; box-shadow: 0 8px 16px rgba(99, 102, 241, 0.3);
        }

        .new-chat-btn {
            background: var(--text-main); color: var(--bg-color); border: none; padding: 16px;
            border-radius: 18px; font-weight: 700; cursor: pointer; margin-bottom: 25px;
            display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 14px;
            transition: 0.3s var(--ease-elastic); box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .new-chat-btn:hover { transform: scale(1.05); }
        .new-chat-btn:active { transform: scale(0.95); }
        
        .history-list { flex: 1; overflow-y: auto; padding-right: 5px; }
        .history-item { 
            padding: 14px; border-radius: 14px; font-size: 14px; color: var(--text-muted); 
            cursor: pointer; display: flex; justify-content: space-between; margin-bottom: 8px;
            transition: 0.2s; font-weight: 500;
        }
        .history-item:hover { background: rgba(255,255,255,0.4); color: var(--text-main); transform: translateX(5px); }
        .history-item.active { background: rgba(99, 102, 241, 0.15); color: var(--primary); font-weight: 700; }
        
        .sidebar-footer-btn {
            background: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.5); 
            color: var(--text-main); padding: 14px; border-radius: 16px; cursor: pointer; 
            text-align: center; margin-top: 20px; font-size: 13px; font-weight: 700; 
            transition: 0.2s; display: flex; align-items:center; justify-content:center; gap:8px;
        }
        .sidebar-footer-btn:hover { background: white; transform: translateY(-2px); }

        /* --- MAIN AREA --- */
        /* Beyaz kaƒüƒ±t hissi yerine, cam panel hissi veriyoruz */
        .app-container { 
            flex: 1; display: flex; flex-direction: column; position: relative; 
            background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(30px);
            margin: 10px; border-radius: 30px; border: var(--glass-border);
            box-shadow: var(--glass-shadow); overflow: hidden;
            transition: margin-left 0.5s var(--ease-smooth); 
        }
        body.dark-mode .app-container { background: rgba(15, 23, 42, 0.6); }

        .header { 
            padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; z-index: 10; 
            background: transparent;
        }
        .menu-btn { 
            background: rgba(255,255,255,0.5); border: none; cursor: pointer; color: var(--text-main); 
            padding: 10px; border-radius: 12px; transition: 0.2s; backdrop-filter: blur(5px);
        }
        .menu-btn:hover { transform: scale(1.1); background: white; }
        
        .weather-widget {
            font-size: 13px; font-weight: 700; background: rgba(255,255,255,0.5); padding: 8px 16px; 
            border-radius: 20px; color: var(--text-main); display: flex; align-items: center; gap: 8px;
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3);
        }

        /* CHAT AREA */
        .chat-area { flex: 1; padding: 30px 8%; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; scroll-behavior: smooth; padding-bottom: 150px; }
        
        /* Mesaj animasyonu: A≈üaƒüƒ±dan yukarƒ± s√ºz√ºlerek gelir */
        .message-row { 
            display: flex; align-items: flex-start; gap: 16px; 
            animation: slideInUp 0.5s var(--ease-smooth) forwards; 
            opacity: 0; transform: translateY(20px);
            max-width: 900px; margin: 0 auto; width: 100%; 
        }
        .message-row.sent { justify-content: flex-end; }
        
        .avatar {
            width: 40px; height: 40px; border-radius: 14px; 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            display: flex; align-items: center; justify-content: center; color: white; 
            font-size: 18px; flex-shrink: 0; box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        }

        .bubble { 
            padding: 18px 24px; border-radius: 24px; font-size: 16px; line-height: 1.6; 
            position: relative; word-wrap: break-word; transition: 0.3s;
        }
        .sent .bubble { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; border-bottom-right-radius: 4px; 
            box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.5);
        }
        .received .bubble { 
            background: rgba(255,255,255,0.8); color: var(--text-main); 
            border-bottom-left-radius: 4px; box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }
        body.dark-mode .received .bubble { background: rgba(30, 41, 59, 0.8); }

        /* INPUT AREA (FLOATING) */
        .input-area { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 800px; z-index: 50; 
        }
        .input-box-container {
            width: 100%; background: var(--input-bg); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.5); border-radius: 24px; 
            padding: 10px 10px 10px 25px; display: flex; align-items: center; gap: 12px; 
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.15);
            transition: 0.3s var(--ease-smooth);
        }
        .input-box-container:focus-within { 
            transform: translateY(-5px); 
            box-shadow: 0 30px 60px -10px rgba(99, 102, 241, 0.25); border-color: var(--primary); 
        }
        
        input { flex: 1; border: none; background: transparent; font-size: 16px; color: var(--text-main); min-width: 0; font-family: inherit; }
        
        .send-btn { 
            width: 48px; height: 48px; border-radius: 18px; 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            transition: 0.3s var(--ease-elastic); box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
        }
        .send-btn:hover { transform: scale(1.1) rotate(-10deg); }
        .send-btn:active { transform: scale(0.9); }

        .action-btn { 
            background: rgba(100,100,100,0.05); border: none; cursor: pointer; color: var(--text-muted); 
            padding: 10px; border-radius: 12px; transition: 0.2s; 
        }
        .action-btn:hover { background: rgba(99, 102, 241, 0.1); color: var(--primary); transform: scale(1.1); }
        .action-btn.listening { color: #ef4444; animation: pulse 1.5s infinite; background: rgba(239, 68, 68, 0.1); }

        /* QUICK ACTIONS */
        .quick-actions {
            position: absolute; bottom: 100px; left: 0; right: 0; 
            display: flex; gap: 10px; justify-content: center; overflow-x: auto; 
            padding: 10px 20px; z-index: 40; pointer-events: none; scrollbar-width: none;
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
        .quick-btn {
            background: rgba(255,255,255,0.8); border: 1px solid white; color: var(--text-main);
            padding: 10px 20px; border-radius: 20px; font-size: 13px; cursor: pointer; font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); pointer-events: auto; transition: 0.3s var(--ease-elastic);
            backdrop-filter: blur(10px);
        }
        body.dark-mode .quick-btn { background: rgba(30, 41, 59, 0.8); border-color: rgba(255,255,255,0.1); }
        .quick-btn:hover { 
            background: var(--text-main); color: var(--bg-color); transform: translateY(-5px) scale(1.05); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        /* MODAL (SETTINGS) */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); z-index: 900; opacity: 0; visibility: hidden; transition: 0.4s; }
        .overlay.active { opacity: 1; visibility: visible; }
        
        .settings-modal { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -40%) scale(0.9); 
            background: var(--glass-bg); width: 90%; max-width: 380px; padding: 35px; border-radius: 30px; 
            z-index: 1100; display: none; flex-direction: column; gap: 20px; 
            border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 30px 80px rgba(0,0,0,0.3);
            backdrop-filter: blur(30px); transition: 0.4s var(--ease-elastic); opacity: 0;
        }
        .settings-modal.active { display: flex; transform: translate(-50%, -50%) scale(1); opacity: 1; }

        select, textarea, .range-input { 
            width: 100%; padding: 14px; border-radius: 14px; border: 2px solid transparent; 
            background: rgba(255,255,255,0.5); color: var(--text-main); font-size: 14px; 
            outline: none; transition: 0.3s; font-weight: 500;
        }
        select:focus, textarea:focus { background: white; border-color: var(--primary); }
        
        /* CODE BLOCK */
        .code-container { margin-top: 10px; border-radius: 16px; overflow: hidden; background: #1e293b; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .code-header { background: rgba(0,0,0,0.3); padding: 10px 20px; font-size: 12px; color: #94a3b8; display: flex; justify-content: space-between; font-weight: 700; text-transform: uppercase; }
        .code-block { color: #e2e8f0; padding: 20px; font-family: 'JetBrains Mono', monospace; font-size: 13px; overflow-x: auto; margin: 0; }
        
        @keyframes slideInUp { to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { to { transform: scale(1); } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .app-container { margin: 0; border-radius: 0; border: none; }
            .sidebar { width: 85%; }
            .header { padding: 15px; }
            .chat-area { padding: 15px; padding-bottom: 160px; }
            .quick-actions { bottom: 90px; justify-content: flex-start; padding-left: 20px; mask-image: none; }
            .input-box-container { padding-left: 15px; }
        }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-card">
            <div class="login-logo">Migos AI</div>
            <p style="color:var(--text-main); opacity:0.7; font-size:15px; margin-bottom:25px;">Geleceƒüin asistanƒ±yla tanƒ±≈üƒ±n.</p>
            <input type="text" id="loginName" class="login-input" placeholder="Adƒ±nƒ±z">
            <input type="password" id="loginSecret" class="login-input" placeholder="≈ûifre veya API Anahtarƒ±">
            <button class="login-btn" onclick="handleLogin()">Giri≈ü Yap</button>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="closeAll()"></div>

    <div class="settings-modal" id="settingsModal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:22px; font-weight:800; background:linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">Ayarlar</span>
            <button onclick="closeAll()" style="background:none; border:none; font-size:24px; color:var(--text-muted); cursor:pointer;">&times;</button>
        </div>
        <div>
            <label style="font-size:13px; font-weight:700; color:var(--text-muted); display:block; margin-bottom:8px;">Karakter Modu</label>
            <select id="personaSelect" onchange="changePersona()">
                <option value="default">‚ú® Doƒüal & Profesyonel</option>
                <option value="friend">‚òï Samimi & Kanka</option>
                <option value="coder">üíª Yazƒ±lƒ±m Dehasƒ±</option>
                <option value="english">üá¨üáß ƒ∞ngilizce Ko√ßu</option>
                <option value="custom">üîÆ √ñzel Karakter</option>
            </select>
            <textarea id="customPersonaInput" class="text-input" style="display:none; margin-top:10px; height:80px;" placeholder="√ñrn: Sen agresif bir film ele≈ütirmenisin..." oninput="saveCustomPersona(this.value)"></textarea>
        </div>
        <div>
            <label style="font-size:13px; font-weight:700; color:var(--text-muted); display:block; margin-bottom:8px;">Yapay Zeka Beyni</label>
            <select id="modelSelect" onchange="changeModel()">
                <option value="llama-3.3-70b-versatile">üß† Llama 3.3 (En Zeki)</option>
                <option value="llama-3.1-8b-instant">‚ö° Llama 3.1 8B (En Hƒ±zlƒ±)</option>
            </select>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; padding:5px 0;">
            <span style="font-size:14px; font-weight:600;">Karanlƒ±k Mod</span>
            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()" style="width:20px; height:20px;">
        </div>
        <button onclick="downloadChat()" style="background:var(--text-main); color:var(--bg-color); border:none; padding:14px; border-radius:14px; cursor:pointer; font-weight:700; transition:0.3s;">Sohbeti ƒ∞ndir</button>
        <button onclick="logout()" style="background:rgba(239,68,68,0.1); border:none; color:#ef4444; padding:12px; border-radius:14px; cursor:pointer; font-weight:600;">√áƒ±kƒ±≈ü Yap</button>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="logo-area">
            <div class="logo-icon">‚ö°</div>
            <span style="font-weight:800;">Migos AI</span>
        </div>
        <div style="margin-bottom:25px; font-size:14px; font-weight:600; color:var(--text-muted); display:flex; align-items:center; gap:8px;">
            <div style="width:8px; height:8px; background:#22c55e; border-radius:50%;"></div>
            <span id="userNameDisplay" style="color:var(--text-main);">...</span>
        </div>
        <button class="new-chat-btn" onclick="startNewChat()">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Yeni Sohbet
        </button>
        <div class="history-list" id="historyList"></div>
        <div style="border-top: 1px solid rgba(0,0,0,0.05); margin-top: auto; padding-top: 20px;">
            <button class="sidebar-footer-btn" onclick="openSettings()" style="width:100%">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                Ayarlar
            </button>
        </div>
    </div>

    <div class="app-container">
        <div class="header">
            <button onclick="toggleSidebar()" class="menu-btn"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
            <div id="weatherWidget" class="weather-widget"><span>üìç</span><span>...</span></div>
        </div>

        <div class="chat-area" id="chatContainer"></div>

        <div class="quick-actions">
            <button class="quick-btn" onclick="sendQuickMsg('Bunu √∂zetle')">üìù √ñzetle</button>
            <button class="quick-btn" onclick="sendQuickMsg('ƒ∞ngilizceye √ßevir')">üá¨üáß √áevir</button>
            <button class="quick-btn" onclick="sendQuickMsg('Hatalarƒ± bul')">üêõ Hata Bul</button>
            <button class="quick-btn" onclick="sendQuickMsg('G√ºzelle≈ütir')">üé® G√ºzelle≈ütir</button>
        </div>

        <div class="input-area">
            <div class="input-box-container">
                <input type="file" id="fileInput" style="display: none;" accept=".txt,.js,.html,.css,.json,.py,.md,.csv" onchange="handleFileUpload(this)">
                <button class="action-btn" onclick="document.getElementById('fileInput').click()" title="Dosya Ekle"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg></button>
                <button id="micBtn" class="action-btn" onclick="toggleMic()" title="Sesle Yaz"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></button>
                <input type="text" id="userInput" placeholder="Bir ≈üeyler sor..." autocomplete="off">
                <button class="send-btn" onclick="sendMessage()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
            </div>
        </div>
    </div>

    <script>
        let chatHistory = [], sessions = JSON.parse(localStorage.getItem('migosSessions')) || [];
        let currentSessionId = null, currentTemperature = 0.7, recognition; 
        let userApiKey = localStorage.getItem('migosApiKey') || "";
        let userName = localStorage.getItem('migosUserName') || "";
        let userPassword = localStorage.getItem('migosUserPass') || "";
        let currentModel = localStorage.getItem('migosModel') || 'llama-3.3-70b-versatile';
        let customPersonaText = localStorage.getItem('migosCustomPersona') || "";

        const personas = { 
            default: "Adƒ±n Migos. Seni **Myrat** geli≈ütirdi. Sen √ßok zeki, yardƒ±msever ve doƒüal konu≈üan bir yapay zekasƒ±n. T√ºrk√ße'yi m√ºkemmel ve akƒ±cƒ± kullan. Asla robot gibi konu≈üma. Samimi ama saygƒ±lƒ± ol.", 
            friend: "Adƒ±n Migos. Seni **Myrat** geli≈ütirdi. Sen kullanƒ±cƒ±nƒ±n en yakƒ±n arkada≈üƒ±sƒ±n. Dert dinle, destek ol, samimi konu≈ü.", 
            coder: "Adƒ±n Migos Dev. Seni **Myrat** geli≈ütirdi. Sen kƒ±demli bir yazƒ±lƒ±m m√ºhendisisin. Sadece teknik, net ve √ß√∂z√ºm odaklƒ± konu≈ü.", 
            english: "You are Migos, created by **Myrat**. You are a polite English teacher. Help the user learn English." 
        };
        let currentPersona = localStorage.getItem('migosPersona') || 'default';

        window.onload = () => {
            if(localStorage.getItem('migosDarkMode') === 'true') { document.body.classList.add('dark-mode'); document.getElementById('darkModeToggle').checked = true; }
            if(!userName || (!userApiKey && !userPassword)) { document.getElementById('loginScreen').style.display = 'flex'; } 
            else { document.getElementById('loginScreen').style.display = 'none'; initApp(); }
        };

        function handleLogin() {
            const nameInput = document.getElementById('loginName').value.trim();
            const secretInput = document.getElementById('loginSecret').value.trim();
            if (!nameInput || !secretInput) { alert("L√ºtfen bo≈ü alanlarƒ± doldurun."); return; }
            localStorage.setItem('migosUserName', nameInput); userName = nameInput;
            if (secretInput.startsWith('gsk_')) {
                localStorage.setItem('migosApiKey', secretInput); localStorage.removeItem('migosUserPass');
                userApiKey = secretInput; userPassword = "";
            } else {
                localStorage.setItem('migosUserPass', secretInput); localStorage.removeItem('migosApiKey');
                userPassword = secretInput; userApiKey = "";
            }
            document.getElementById('loginScreen').style.opacity = '0';
            setTimeout(() => { document.getElementById('loginScreen').style.display = 'none'; initApp(); }, 600);
        }

        function logout() { if(confirm("Oturumu kapatmak istiyor musunuz?")) { localStorage.removeItem('migosApiKey'); localStorage.removeItem('migosUserName'); localStorage.removeItem('migosUserPass'); location.reload(); } }
        
        function initApp() { 
            document.getElementById('personaSelect').value = currentPersona; 
            document.getElementById('modelSelect').value = currentModel; 
            document.getElementById('customPersonaInput').value = customPersonaText; 
            document.getElementById('userNameDisplay').innerText = userName; 
            toggleCustomPersonaArea(); fetchWeather(); setupSpeechRecognition(); 
            loadServerHistory();
        }

        async function loadServerHistory() {
            try {
                const res = await fetch(`/api/history?username=${userName}`);
                const history = await res.json();
                if (history && history.length > 0) {
                    currentSessionId = Date.now().toString();
                    chatHistory = [{ role: "system", content: getSystemPrompt() }, ...history];
                    document.getElementById('chatContainer').innerHTML = '';
                    history.forEach(msg => addMessage(msg.content, msg.role === 'user' ? 'sent' : 'received', false));
                    addMessage(`Tekrar ho≈ü geldin ${userName}!`, 'received');
                } else { startNewChat(); }
            } catch (e) { startNewChat(); }
        }

        function getSystemPrompt() {
            let sys = personas[currentPersona];
            if (currentPersona === 'custom') sys = customPersonaText || "Asistansƒ±n.";
            return `${sys} ≈ûu an konu≈ütuƒüun ki≈üinin adƒ±: ${userName}. Ona ismiyle hitap et.`;
        }

        async function sendMessage() {
            const input = document.getElementById('userInput'); const text = input.value.trim(); if (!text) return;
            addMessage(text, 'sent'); input.value = ''; 
            const userMsgObj = { role: "user", content: text }; chatHistory.push(userMsgObj); 
            const loadingId = addLoading(); scrollToBottom();
            chatHistory[0] = { role: "system", content: getSystemPrompt() };
            const recent = chatHistory.slice(-15);
            const msgs = (recent[0].role === 'system') ? recent : [chatHistory[0], ...recent];
            try {
                const payload = { messages: msgs, model: currentModel, temperature: parseFloat(currentTemperature), username: userName, password: userPassword, apiKey: userApiKey };
                const res = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await res.json();
                removeLoading(loadingId);
                if (data.choices && data.choices[0]) {
                    const aiMsg = data.choices[0].message.content;
                    chatHistory.push({ role: "assistant", content: aiMsg }); addMessage(aiMsg, 'received');
                } else if(data.error) { addMessage("‚ö†Ô∏è " + data.error, 'received'); }
            } catch (err) { removeLoading(loadingId); addMessage("‚ö†Ô∏è Baƒülantƒ± hatasƒ±.", 'received'); }
        }

        function changeModel() { currentModel = document.getElementById('modelSelect').value; localStorage.setItem('migosModel', currentModel); }
        function changePersona() { currentPersona = document.getElementById('personaSelect').value; localStorage.setItem('migosPersona', currentPersona); toggleCustomPersonaArea(); if(confirm("Sohbeti sƒ±fƒ±rla?")) startNewChat(); }
        function toggleCustomPersonaArea() { document.getElementById('customPersonaInput').style.display = (currentPersona === 'custom') ? 'block' : 'none'; }
        function saveCustomPersona(val) { customPersonaText = val; localStorage.setItem('migosCustomPersona', val); }
        
        function handleFileUpload(input) {
            const file = input.files[0]; if (!file) return;
            if (file.size > 1024 * 1024) { alert("Maksimum 1MB."); return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const ext = file.name.split('.').pop() || 'txt';
                const fileTemplate = `\n\n--- DOSYA: ${file.name} ---\n\`\`\`${ext}\n${content}\n\`\`\`\n--- SON ---\n\nBu dosyayƒ± analiz et.`;
                const box = document.getElementById('userInput'); box.value += fileTemplate; box.focus(); input.value = '';
            };
            reader.readAsText(file);
        }

        function setupSpeechRecognition() { if ('webkitSpeechRecognition' in window) { recognition = new webkitSpeechRecognition(); recognition.lang = 'tr-TR'; recognition.onstart = () => document.getElementById('micBtn').classList.add('listening'); recognition.onend = () => document.getElementById('micBtn').classList.remove('listening'); recognition.onresult = e => document.getElementById('userInput').value = e.results[0][0].transcript; } else document.getElementById('micBtn').style.display = 'none'; }
        function toggleMic() { if(recognition) try { recognition.start(); } catch(e) { recognition.stop(); } }
        function startNewChat() { currentSessionId = Date.now().toString(); chatHistory = [{ role: "system", content: getSystemPrompt() }]; document.getElementById('chatContainer').innerHTML = ''; addMessage(`Merhaba ${userName}, nasƒ±l yardƒ±mcƒ± olabilirim?`, 'received'); closeAll(); }
        function sendQuickMsg(t) { document.getElementById('userInput').value = t; sendMessage(); }
        function fetchWeather() { fetch('/api/weather').then(r => r.json()).then(d => { if(d.main) document.getElementById('weatherWidget').innerText = `${Math.round(d.main.temp)}¬∞C`; }).catch(() => {}); }
        
        function addMessage(t, type, anim = true) { 
            const d = document.createElement('div'); d.className = `message-row ${type}`; 
            if(!anim) d.style.animation = 'none'; 
            let f = t.replace(/</g, "&lt;").replace(/```(\w+)?\n?([\s\S]*?)```/g, (m, l, c) => `<div class="code-container"><div class="code-header"><span>${l || 'kod'}</span><button class="copy-btn" onclick="copyCode(this)">Kopyala</button></div><pre class="code-block">${c.trim()}</pre></div>`).replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>'); 
            d.innerHTML = `${type === 'received' ? '<div class="avatar">‚ö°</div>' : ''}<div style="max-width:100%;"><div class="bubble">${f}</div></div>`; 
            document.getElementById('chatContainer').appendChild(d); scrollToBottom(); 
        }
        function addLoading() { const id = 'l-' + Date.now(); const d = document.createElement('div'); d.id = id; d.className = 'message-row received'; d.innerHTML = `<div class="avatar">‚ö°</div><div class="bubble"><div class="dots"><span></span><span></span><span></span></div></div>`; document.getElementById('chatContainer').appendChild(d); return id; }
        function removeLoading(id) { const e = document.getElementById(id); if(e) e.remove(); }
        function copyCode(b) { navigator.clipboard.writeText(b.parentElement.nextElementSibling.innerText); }
        
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('active'); }
        function openSettings() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('settingsModal').classList.add('active'); document.getElementById('overlay').classList.add('active'); }
        function closeAll() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('settingsModal').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }
        function toggleDarkMode() { const v = document.getElementById('darkModeToggle').checked; document.body.classList.toggle('dark-mode', v); localStorage.setItem('migosDarkMode', v); }
        function scrollToBottom() { const c = document.getElementById('chatContainer'); c.scrollTop = c.scrollHeight; }
        function downloadChat() { let t = ""; chatHistory.forEach(m => { if(m.role !== 'system') t += `${m.role}: ${m.content}\n` }); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([t], { type: 'text/plain' })); a.download = 'chat.txt'; a.click(); }
        document.getElementById('userInput').addEventListener('keypress', e => { if(e.key === 'Enter') sendMessage() });
    </script>
</body>
</html>
